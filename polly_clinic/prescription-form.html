<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Prescription - AppointCare</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
    <style>
        .current-time { position: absolute; top: 20px; right: 20px; font-weight: bold; }
        .medicine-row { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 5px; }
        .remove-btn { background: #dc3545; color: white; border: none; border-radius: 3px; padding: 5px 10px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">ðŸ©º Generate Prescription</a>
            <div class="current-time" id="currentDateTime"></div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h5>Prescription Form</h5>
                        <div class="text-muted">Patient ID: <span id="patientId"></span></div>
                    </div>
                    <div class="card-body">
                        <form id="prescriptionForm">
                            <div id="medicineContainer">
                                <div class="medicine-row">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">Medicine Name:</label>
                                            <input type="text" class="form-control medicine-name" required>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Quantity:</label>
                                            <input type="text" class="form-control quantity" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Timing:</label>
                                            <select class="form-control timing" required>
                                                <option value="">Select Timing</option>
                                                <option value="Morning - Before Meal">Morning - Before Meal</option>
                                                <option value="Morning - After Meal">Morning - After Meal</option>
                                                <option value="Evening - Before Meal">Evening - Before Meal</option>
                                                <option value="Evening - After Meal">Evening - After Meal</option>
                                                <option value="Night - Before Meal">Night - Before Meal</option>
                                                <option value="Night - After Meal">Night - After Meal</option>
                                                <option value="Twice Daily">Twice Daily</option>
                                                <option value="Thrice Daily">Thrice Daily</option>
                                            </select>
                                        </div>
                                        <div class="col-md-1">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="button" class="btn remove-btn" onclick="removeMedicine(this)" style="display:none;">Ã—</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mb-3">
                                <button type="button" class="btn btn-outline-primary" onclick="addMedicine()">+ Add Medicine</button>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" onclick="printPrescription()">Print</button>
                                <button type="submit" class="btn btn-success">Submit & Complete</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        emailjs.init("YOUR_EMAILJS_USER_ID");
        
        let appointmentId, patientId;

        document.addEventListener('DOMContentLoaded', function() {
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            const urlParams = new URLSearchParams(window.location.search);
            appointmentId = urlParams.get('appointmentId');
            patientId = urlParams.get('patientId');
            
            document.getElementById('patientId').textContent = patientId;
        });

        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentDateTime').textContent = now.toLocaleString();
        }

        function addMedicine() {
            const container = document.getElementById('medicineContainer');
            const newRow = document.createElement('div');
            newRow.className = 'medicine-row';
            newRow.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <label class="form-label">Medicine Name:</label>
                        <input type="text" class="form-control medicine-name" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Quantity:</label>
                        <input type="text" class="form-control quantity" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Timing:</label>
                        <select class="form-control timing" required>
                            <option value="">Select Timing</option>
                            <option value="Morning - Before Meal">Morning - Before Meal</option>
                            <option value="Morning - After Meal">Morning - After Meal</option>
                            <option value="Evening - Before Meal">Evening - Before Meal</option>
                            <option value="Evening - After Meal">Evening - After Meal</option>
                            <option value="Night - Before Meal">Night - Before Meal</option>
                            <option value="Night - After Meal">Night - After Meal</option>
                            <option value="Twice Daily">Twice Daily</option>
                            <option value="Thrice Daily">Thrice Daily</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn remove-btn" onclick="removeMedicine(this)">Ã—</button>
                    </div>
                </div>
            `;
            container.appendChild(newRow);
        }

        function removeMedicine(button) {
            button.closest('.medicine-row').remove();
        }

        function printPrescription() {
            window.print();
        }

        document.getElementById('prescriptionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const medicines = [];
            document.querySelectorAll('.medicine-row').forEach(row => {
                const medicine = {
                    name: row.querySelector('.medicine-name').value,
                    quantity: row.querySelector('.quantity').value,
                    timing: row.querySelector('.timing').value
                };
                medicines.push(medicine);
            });

            try {
                const response = await fetch('/ClinicBook/submitPrescription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        appointmentId,
                        patientId,
                        medicines,
                        doctorId: localStorage.getItem('doctorId') || 1
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    await sendPrescriptionEmail(result.patientEmail, medicines);
                    alert('Prescription submitted successfully and appointment marked as completed');
                    window.location.href = 'doctor-appointments.html';
                } else {
                    alert('Failed to submit prescription');
                }
            } catch (error) {
                console.error('Error submitting prescription:', error);
                alert('Error submitting prescription');
            }
        });

        async function sendPrescriptionEmail(email, medicines) {
            const medicineList = medicines.map(med => 
                `${med.name} - ${med.quantity} - ${med.timing}`
            ).join('\n');

            const templateParams = {
                to_email: email,
                patient_id: patientId,
                medicines: medicineList,
                doctor_name: localStorage.getItem('doctorName') || 'Doctor'
            };

            try {
                await emailjs.send('YOUR_SERVICE_ID', 'PRESCRIPTION_TEMPLATE_ID', templateParams);
            } catch (error) {
                console.error('Error sending prescription email:', error);
            }
        }
    </script>
</body>
</html>